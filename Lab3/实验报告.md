# XGBoost å®éªŒ

<center>PB18071477  æ•–æ—­æ‰¬</center>

## åŸç†

ç»™å®š $n$ ä¸ªæ ·æœ¬ã€$m$ ä¸ªç‰¹å¾çš„äºŒåˆ†ç±»é—®é¢˜æ•°æ®é›† $D=\{ (X_i,y_i) \}(|D|=n,X_i \in \R^m,y_i \in\{0,1\})$ ï¼Œ`XGBoost`æ¨¡å‹é‡‡ç”¨ $K$ æ¬¡è¿­ä»£çš„ç»“æœä½œä¸ºè¾“å‡ºç»“æœã€‚$X_i$ çš„è¾“å‡ºä¸º $\hat{y_i}$ï¼Œæœ€ç»ˆé¢„æµ‹ç»“æœä¸º $p_i$ï¼Œæœ‰

$$
\hat{y_i}=\phi(X_i)=\sum_{k=1}^{K}f_k(X_i),\quad f_k \in F \tag{1}
$$

$$
p_i=round\Big(\dfrac{1}{1+e^{-\hat{y_i}}}\Big) \tag{2}
$$

å…¶ä¸­ $F=\{ f(X)=w_{q(X)} \}(q:\R^m\rightarrow \{1,2,\dots,T\},w \in \R^T)$ è¡¨ç¤º`XGBoost`æ ‘ç»“æ„ç©ºé—´é›†ï¼Œå„ä¸ªå˜é‡çš„å«ä¹‰å¦‚ä¸‹ï¼š

-   $q$ è¡¨ç¤ºæ ‘çš„ç»“æ„ï¼Œå¯ä»¥å°†æ ·æœ¬æ˜ å°„åˆ°ç›¸åº”çš„å¶å­èŠ‚ç‚¹ï¼›
-   $T$ è¡¨ç¤º`XGBoost`æ ‘å¶å­èŠ‚ç‚¹çš„æ•°é‡ï¼›
-   æ¯ä¸ª $f_k$ éƒ½å¯¹åº”ç‹¬ç«‹çš„æ ‘ç»“æ„ $q$ å’Œæƒé‡ $w$ ã€‚

æœ€ç»ˆæŸå¤±å‡½æ•°åŒ–ç®€ä¸º

$$
Obj^{(t)}=\sum_{j=1}^{T}[G_jw_j+\frac{1}{2}(H_j+\lambda)w_j^2]+\gamma T \tag{3}
$$

å…¶ä¸­

$$
g_i= \dfrac{\partial l(y_i,\hat{y_i}^{(t-1)})}{\partial \hat{y_i}^{(t-1)}},\quad h_ğ‘– = \dfrac{\partial^2 l(y_i,\hat{y_i}^{(t-1)})}{\partial^2 \hat{y_i}^{(t-1)}}  \tag{4}
$$

$$
I_j=\{ i|q(X_i)=j \}
$$

$$
G_j=\sum_{i \in I_j}g_i,\quad H_j=\sum_{i \in I_j}h_i  \tag{5}
$$

$Obj^{(t)}$ å¯¹ $w_j$ æ±‚å¯¼ç­‰äº $0$ å¯å¾—

$$
w_j^*=-\dfrac{G_j}{H_j+\lambda} \tag{6}
$$

æ‰€ä»¥æ¥ä¸‹æ¥éœ€è¦ä¸æ–­å¯»æ‰¾åˆ’åˆ†æ–¹å¼æ¥æ„é€ å‡ºæ ‘çš„ç»“æ„ï¼Œå¯ä»¥å¯¹äºæ•°æ®é›†ï¼Œéå†æ‰€æœ‰åˆ’åˆ†å±æ€§å’Œåˆ†ç•Œç‚¹ï¼Œæ±‚å‡º

$$
Gain=\dfrac{1}{2}\Big[\dfrac{G_L^2}{H_L+\lambda}+\dfrac{G_R^2}{H_R+\lambda}-\dfrac{(G_L+G_R)^2}{H_L+H_R+\lambda}\Big] \tag{7}
$$

æŒ‰ç…§å–å¾— $Gain$ æœ€å¤§å€¼çš„æ–¹å¼è¿›è¡Œåˆ’åˆ†ï¼Œå†å¯¹åˆ’åˆ†åçš„ä¸¤ä¸ªå­é›†ç»§ç»­æŒ‰ç…§è¿™æ ·çš„è§„åˆ™åˆ’åˆ†ï¼ŒåŒæ—¶æ ‘çš„å±‚æ¬¡å¢åŠ  $1$ã€‚å½“æ ‘çš„å±‚æ¬¡è¾¾åˆ°æœ€å¤§å€¼æˆ–å½“å‰é›†åˆå°äºæœ€å°åˆ’åˆ†å—å¤§å°æ—¶åœæ­¢åˆ’åˆ†å¾—åˆ°ä¸€ä¸ªå¶å­ç»“ç‚¹ï¼ŒæŒ‰ç…§ $(6)$ å¼è®¡ç®—å‡ºè¯¥å¶å­çš„æƒå€¼ã€‚è®­ç»ƒå®Œå½“å‰æ ‘ï¼Œæ›´æ–° $\hat{y_i}$ åå†è®­ç»ƒä¸‹ä¸€æ£µæ ‘ï¼Œæœ€ç»ˆå¾—åˆ°åŒ…å« $K$ è¯¾æ ‘çš„`XGBoost`æ¨¡å‹ï¼Œæ®æ­¤å¯ç”¨è¯¥æ¨¡å‹å¯¹æ•°æ®é›†è¿›è¡Œé¢„æµ‹ï¼Œè¾“å‡ºè®­ç»ƒé›†å’Œæµ‹è¯•é›†çš„ç²¾åº¦ã€‚

åœ¨æœ¬å®ç°ä¸­ï¼ŒæŸå¤±å‡½æ•°ä½¿ç”¨çš„æ˜¯ $logistic$ æŸå¤±ï¼Œå³

$$
l(y_i,\hat{y_i})=y_i\ln(1+e^{-\hat{y_i}})+(1-y_i)\ln(1+e^{-\hat{y_i}}) \tag{8}
$$

ä»¤

$$
p_i=\dfrac{1}{1+e^{-\hat{y_i}}} \tag{9}
$$

åˆ™è®¡ç®—å¾—

$$
g_i=p_i-y_i,\quad h_i=p_i(1-p_i) \tag{10}
$$

## ç¼–ç¨‹å®ç°

çŸ©é˜µè¿ç®—ä½¿ç”¨`python`çš„`numpy`åº“å®ç°ã€‚

`XGBoost`æ¨¡å‹çš„è®­ç»ƒå’Œé¢„æµ‹éƒ¨åˆ†å¦‚ä¸‹ï¼š

```python
class XGBoost:
    def fit(self, X, y):
        p = np.zeros(np.shape(y))
        for tree in self.trees:
            tree.fit(X, y, p)
            p += tree.predict(X)

    def predict(self, X):
        y_pred = np.zeros(X.shape[0])
        for tree in self.trees:
            y_pred += tree.predict(X)
        h = 1.0/(1.0+np.exp(-y_pred))
        return np.round(h)
```

å•æ£µå­æ ‘çš„è®­ç»ƒå’Œé¢„æµ‹éƒ¨åˆ†å¦‚ä¸‹ï¼š

```python
class XGBoostTree:
    def fit(self, X, y, p):
        G = self.loss.grad(y, p)
        H = self.loss.hess(y, p)
        XypGH = np.c_[X, y, p, G, H]
        self.root = self.build_tree(XypGH)

    def build_tree(self, XypGH, cur_depth=1):
        max_gain = 0
        LXyp = None
        RXyp = None
        feature = None
        threshold = None
        split_point = None
        size = np.shape(XypGH)[0]
        d = np.shape(XypGH)[1] - 4  # å±æ€§ä¸ªæ•°
        if size >= self.split_size and cur_depth <= self.max_depth:
            for f in range(d):
                XypGH = XypGH[np.lexsort(XypGH.T[f, None])]
                unique_values = np.unique(XypGH[:, f])
                for fv in unique_values:
                    split_i = np.searchsorted(XypGH[:, f], fv)
                    g_l = np.sum(XypGH[:split_i, -2])
                    g_r = np.sum(XypGH[split_i:, -2])
                    h_l = np.sum(XypGH[:split_i, -1])
                    h_r = np.sum(XypGH[split_i:, -1])
                    gain = 0.5*(np.square(g_l)/(h_l+self.la)
                                + np.square(g_r)/(h_r+self.la)
                                - np.square(g_l+g_r)/(h_l+h_r+self.la))
                    - self.gamma
                    if gain >= max_gain and gain > self.min_gain:
                        max_gain = gain
                        feature = f
                        threshold = fv
                        split_point = split_i
            if max_gain > self.min_gain:
                XypGH = XypGH[np.lexsort(XypGH.T[feature, None])]
                LXypGH = XypGH[:split_point]
                RXypGH = XypGH[split_point:]
                left = self.build_tree(LXypGH, cur_depth + 1)
                right = self.build_tree(RXypGH, cur_depth + 1)
                return self.Node(feature, threshold, left, right)
        g = np.sum(XypGH[:, -2])
        h = np.sum(XypGH[:, -1])
        leaf_value = self.eta*(-g / (h + self.la))
        return self.Node(value=leaf_value)

    def predict_value(self, x, tree):
        if tree.value is not None:
            return tree.value
        feature_value = x[tree.feature]
        if feature_value < tree.threshold:
            return self.predict_value(x, tree.left)
        else:
            return self.predict_value(x, tree.right)

    def predict(self, X):
        y_pred = []
        for x in X:
            y_pred.append(self.predict_value(x, self.root))
        p = np.array(y_pred)
        return p

```

å®Œæ•´å®éªŒæºç è§å‹ç¼©åŒ…ä¸­çš„[XGBoost.py](XGBoost.py)ã€‚

## è¿ç®—ç»“æœ

### å®ä¾‹

åœ¨ä¸»å‡½æ•°ä¸­ä½¿ç”¨é»˜è®¤è¶…å‚æ•°(è¯¦è§æºç )è°ƒç”¨ä¸‹é¢çš„å®ä¾‹

```python
# è®­ç»ƒæ¨¡å‹
xgbt = XGBoost()
xgbt.fit(x_train, y_train)

# è®­ç»ƒé›†å’Œæµ‹è¯•é›†ç²¾åº¦
p_train = xgbt.predict(x_train)
p_test = xgbt.predict(x_test)
print("è®­ç»ƒé›†ç²¾åº¦ä¸ºï¼š{:.2f} %".format(
    (p_train == y_train).mean() * 100))
print("æµ‹è¯•é›†ç²¾åº¦ä¸ºï¼š{:.2f} %".format(
    (p_test == y_test).mean() * 100))
```

å‘½ä»¤è¡Œè¾“å‡ºç»“æœä¸º

```text
è®­ç»ƒé›†ç²¾åº¦ä¸ºï¼š83.58 %
æµ‹è¯•é›†ç²¾åº¦ä¸ºï¼š76.47 %
```

### è®­ç»ƒç»“æœ

<center>
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" 
    src="img\XGBoostTree1.svg">
    <br>
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">XGBoostæ¨¡å‹ä¸­çš„ç¬¬1æ£µå†³ç­–å­æ ‘</div>
</center>

<center>
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" 
    src="img\XGBoostTree2.svg">
    <br>
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">XGBoostæ¨¡å‹ä¸­çš„ç¬¬2æ£µå†³ç­–å­æ ‘</div>
</center>

<center>
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" 
    src="img\XGBoostTree3.svg">
    <br>
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">XGBoostæ¨¡å‹ä¸­çš„ç¬¬3æ£µå†³ç­–å­æ ‘</div>
</center>
### é¢„æµ‹æ•ˆæœ

åœ¨æµ‹è¯•é›†ä¸Šçš„é¢„æµ‹ç²¾åº¦ä¸º $76.47 \%$ ã€‚

## æ€»ç»“

é¢˜ç›®è¦æ±‚çš„ Baseline ä¸º

```text
æµ‹è¯„æŒ‡æ ‡ï¼šç²¾åº¦å€¼ï¼Œæ­£ç¡®é¢„æµ‹å æ•´ä½“çš„æ¯”ä¾‹
æµ‹è¯•é›†ç²¾åº¦ï¼š0.7
```

æˆ‘è®­ç»ƒå‡ºçš„**XGBoostæ¨¡å‹**æµ‹è¯•é›†ç²¾åº¦ä¸º $76.47 \%$ï¼Œæ€§èƒ½è¾¾æ ‡ã€‚
